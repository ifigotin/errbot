
    <!doctype html>



<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>errbot.backends.slack &mdash; Err 3.2.3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/err.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '3.2.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Err 3.2.3 documentation" href="../../../index.html" />
    <link rel="up" title="errbot" href="../../errbot.html" />
    <script type="text/javascript">
        // GitHub pages offers no way to redirect to a canonical location, so we
        // have to make do with hacky javascript redirection :(
        if (document.location.protocol != "file:" && document.location.host != "errbot.io") {
            var path = document.location.pathname.replace('/err/', '/');
            document.location = "http://errbot.io" + path;
        }
    </script>
    <link rel="icon" type="image/png" href="../../../_static/err.png"/>
    <link rel="apple-touch-icon" href="../../../_static/err.png"/>
    <link rel="stylesheet" href="../../../_static/fancybox/jquery.fancybox.css" type="text/css"
          media="screen"/>
    <script type="text/javascript" src="../../../_static/fancybox/jquery.fancybox.pack.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9"/>
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-32534172-1']);
        _gaq.push(['_trackPageview']);

        (function () {
            var ga = document.createElement('script');
            ga.type = 'text/javascript';
            ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(ga, s);
        })();

        // Gitter button
        ((window.gitter = {}).chat = {}).options = {
             room: 'errbotio/errbot'
        };
   </script>
   <script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

  </head>
  <body role="document">
    
    

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Err 3.2.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../errbot.html" accesskey="U">errbot</a> &raquo;</li> 
      </ul>
    </div>
      

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for errbot.backends.slack</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>

<span class="kn">from</span> <span class="nn">errbot.backends.base</span> <span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">Presence</span><span class="p">,</span> <span class="n">ONLINE</span><span class="p">,</span> <span class="n">AWAY</span><span class="p">,</span> <span class="n">MUCRoom</span><span class="p">,</span> <span class="n">RoomError</span><span class="p">,</span> <span class="n">RoomDoesNotExistError</span><span class="p">,</span> \
    <span class="n">UserDoesNotExistError</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">,</span> <span class="n">MUCIdentifier</span>
<span class="kn">from</span> <span class="nn">errbot.errBot</span> <span class="kn">import</span> <span class="n">ErrBot</span>
<span class="kn">from</span> <span class="nn">errbot.utils</span> <span class="kn">import</span> <span class="n">deprecated</span><span class="p">,</span> <span class="n">PY3</span><span class="p">,</span> <span class="n">split_string_after</span>
<span class="kn">from</span> <span class="nn">errbot.rendering</span> <span class="kn">import</span> <span class="n">imtext</span>


<span class="c1"># Can&#39;t use __name__ because of Yapsy</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;errbot.backends.slack&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">backports.functools_lru_cache</span> <span class="kn">import</span> <span class="n">lru_cache</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">slackclient</span> <span class="kn">import</span> <span class="n">SlackClient</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not start the Slack back-end&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span>
        <span class="s2">&quot;You need to install the slackclient package in order to use the Slack &quot;</span>
        <span class="s2">&quot;back-end. You should be able to install this package using: &quot;</span>
        <span class="s2">&quot;pip install slackclient&quot;</span>
    <span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PY3</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Could not start the Slack back-end&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span>
        <span class="s2">&quot;I cannot start the Slack back-end because I cannot import the SlackClient. &quot;</span>
        <span class="s2">&quot;Python 3 compatibility on SlackClient is still quite young, you may be &quot;</span>
        <span class="s2">&quot;running an old version or perhaps they released a version with a Python &quot;</span>
        <span class="s2">&quot;3 regression. As a last resort to fix this, you could try installing the &quot;</span>
        <span class="s2">&quot;latest master version from them using: &quot;</span>
        <span class="s2">&quot;pip install --upgrade https://github.com/slackhq/python-slackclient/archive/master.zip&quot;</span>
    <span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># The Slack client automatically turns a channel name into a clickable</span>
<span class="c1"># link if you prefix it with a #. Other clients receive this link as a</span>
<span class="c1"># token matching this regex.</span>
<span class="n">SLACK_CLIENT_CHANNEL_HYPERLINK</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;^&lt;#(?P&lt;id&gt;(C|G)[0-9A-Z]+)&gt;$&#39;</span><span class="p">)</span>

<span class="c1"># Empirically determined message size limit.</span>
<span class="n">SLACK_MESSAGE_LIMIT</span> <span class="o">=</span> <span class="mi">4096</span>

<span class="n">USER_IS_BOT_HELPTEXT</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Connected to Slack using a bot account, which cannot manage &quot;</span>
    <span class="s2">&quot;channels itself (you must invite the bot to channels instead, &quot;</span>
    <span class="s2">&quot;it will auto-accept) nor invite people.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
    <span class="s2">&quot;If you need this functionality, you will have to create a &quot;</span>
    <span class="s2">&quot;regular user account and connect Err using that account. &quot;</span>
    <span class="s2">&quot;For this, you will also need to generate a user token at &quot;</span>
    <span class="s2">&quot;https://api.slack.com/web.&quot;</span>
<span class="p">)</span>


<div class="viewcode-block" id="SlackAPIResponseError"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackAPIResponseError">[docs]</a><span class="k">class</span> <span class="nc">SlackAPIResponseError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Slack API returned a non-OK response&quot;&quot;&quot;</span>

<div class="viewcode-block" id="SlackAPIResponseError.__init__"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackAPIResponseError.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param error:</span>
<span class="sd">            The &#39;error&#39; key from the API response data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">error</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SlackIdentifier"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackIdentifier">[docs]</a><span class="k">class</span> <span class="nc">SlackIdentifier</span><span class="p">(</span><span class="n">Identifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class describes a person on Slack&#39;s network.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SlackIdentifier.__init__"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackIdentifier.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">userid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">channelid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">userid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This is not a Slack user or bot id: </span><span class="si">%s</span><span class="s1"> (should start with U or B)&#39;</span> <span class="o">%</span> <span class="n">userid</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">channelid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">channelid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;This is not a valid Slack channelid: </span><span class="si">%s</span><span class="s1"> (should start with D, C or G)&#39;</span> <span class="o">%</span> <span class="n">channelid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span> <span class="o">=</span> <span class="n">userid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_channelid</span> <span class="o">=</span> <span class="n">channelid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span> <span class="o">=</span> <span class="n">sc</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">userid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack user ID to their user name&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot find user with ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channelid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channelid</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">channelname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack channel ID to its channel name&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channelid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="n">channel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_channelid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">channel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RoomDoesNotExistError</span><span class="p">(</span><span class="s2">&quot;No channel with ID </span><span class="si">%s</span><span class="s2"> exists&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channelid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">domain</span>

    <span class="c1"># Compatibility with the generic API.</span>
    <span class="n">person</span> <span class="o">=</span> <span class="n">userid</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">channelid</span>
    <span class="n">nick</span> <span class="o">=</span> <span class="n">username</span>

    <span class="c1"># Override for ACLs</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">aclattr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: Don&#39;t use str(self) here because that will return</span>
        <span class="c1"># an incorrect format from SlackMUCOccupant.</span>
        <span class="k">return</span> <span class="s2">&quot;@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fullname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack user ID to their user name&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">users</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Cannot find user with ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userid</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">real_name</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;@</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()</span></div>


<div class="viewcode-block" id="SlackMUCOccupant"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackMUCOccupant">[docs]</a><span class="k">class</span> <span class="nc">SlackMUCOccupant</span><span class="p">(</span><span class="n">MUCIdentifier</span><span class="p">,</span> <span class="n">SlackIdentifier</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class represents a person inside a MUC.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">room</span> <span class="o">=</span> <span class="n">SlackIdentifier</span><span class="o">.</span><span class="n">channelname</span>

    <span class="k">def</span> <span class="nf">__unicode__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">room</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__unicode__</span><span class="p">()</span></div>


<div class="viewcode-block" id="SlackBackend"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend">[docs]</a><span class="k">class</span> <span class="nc">SlackBackend</span><span class="p">(</span><span class="n">ErrBot</span><span class="p">):</span>
<div class="viewcode-block" id="SlackBackend.__init__"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">identity</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">BOT_IDENTITY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">fatal</span><span class="p">(</span>
                <span class="s1">&#39;You need to set your token (found under &quot;Bot Integration&quot; on Slack) in &#39;</span>
                <span class="s1">&#39;the BOT_IDENTITY setting in your configuration. Without this token I &#39;</span>
                <span class="s1">&#39;cannot connect to Slack.&#39;</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># Will be initialized in serve_once</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">imtext</span><span class="p">()</span></div>

<div class="viewcode-block" id="SlackBackend.api_call"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.api_call">[docs]</a>    <span class="k">def</span> <span class="nf">api_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make an API call to the Slack API and return response data.</span>

<span class="sd">        This is a thin wrapper around `SlackClient.server.api_call`.</span>

<span class="sd">        :param method:</span>
<span class="sd">            The API method to invoke (see https://api.slack.com/methods/).</span>
<span class="sd">        :param raise_errors:</span>
<span class="sd">            Whether to raise :class:`~SlackAPIResponseError` if the API</span>
<span class="sd">            returns an error</span>
<span class="sd">        :param data:</span>
<span class="sd">            A dictionary with data to pass along in the API request.</span>
<span class="sd">        :returns:</span>
<span class="sd">            The JSON-decoded API response</span>
<span class="sd">        :raises:</span>
<span class="sd">            :class:`~SlackAPIResponseError` if raise_errors is True and the</span>
<span class="sd">            API responds with `{&quot;ok&quot;: false}`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">raise_errors</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SlackAPIResponseError</span><span class="p">(</span>
                <span class="s2">&quot;Slack API call to </span><span class="si">%s</span><span class="s2"> failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]),</span>
                <span class="n">error</span><span class="o">=</span><span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="SlackBackend.serve_once"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.serve_once">[docs]</a>    <span class="k">def</span> <span class="nf">serve_once</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span> <span class="o">=</span> <span class="n">SlackClient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying authentication token&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s2">&quot;auth.test&quot;</span><span class="p">,</span> <span class="n">raise_errors</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">SlackAPIResponseError</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="s2">&quot;Couldn&#39;t authenticate with Slack. Server said: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Token accepted&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bot_identifier</span> <span class="o">=</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">])</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connecting to Slack real-time-messaging API&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">rtm_connect</span><span class="p">():</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Connected&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reset_reconnection_count</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">rtm_read</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_slack_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Interrupt received, shutting down..&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error reading from RTM stream:&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Triggering disconnect callback&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">disconnect_callback</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Connection failed, invalid token ?&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_dispatch_slack_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an incoming message from slack.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">message</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Ignoring non-event message: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">event_type</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>

        <span class="n">event_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;hello&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hello_event_handler</span><span class="p">,</span>
            <span class="s1">&#39;presence_change&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_presence_change_event_handler</span><span class="p">,</span>
            <span class="s1">&#39;team_join&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_team_join_event_handler</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_message_event_handler</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">event_handler</span> <span class="o">=</span> <span class="n">event_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">event_handler</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No event handler available for </span><span class="si">%s</span><span class="s2">, ignoring this event&quot;</span> <span class="o">%</span> <span class="n">event_type</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Processing slack event: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="n">event_handler</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> event handler raised an exception&quot;</span> <span class="o">%</span> <span class="n">event_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_hello_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Event handler for the &#39;hello&#39; event&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_callback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_presence</span><span class="p">(</span><span class="n">Presence</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bot_identifier</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">ONLINE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_presence_change_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Event handler for the &#39;presence_change&#39; event&quot;&quot;&quot;</span>

        <span class="n">idd</span> <span class="o">=</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">])</span>
        <span class="n">presence</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;presence&#39;</span><span class="p">]</span>
        <span class="c1"># According to https://api.slack.com/docs/presence, presence can</span>
        <span class="c1"># only be one of &#39;active&#39; and &#39;away&#39;</span>
        <span class="k">if</span> <span class="n">presence</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ONLINE</span>
        <span class="k">elif</span> <span class="n">presence</span> <span class="o">==</span> <span class="s1">&#39;away&#39;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">AWAY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;It appears the Slack API changed, I received an unknown presence type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">presence</span>
            <span class="p">)</span>
            <span class="n">status</span> <span class="o">=</span> <span class="n">ONLINE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_presence</span><span class="p">(</span><span class="n">Presence</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="n">idd</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_team_join_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">parse_user_data</span><span class="p">((</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],))</span>

    <span class="k">def</span> <span class="nf">_message_event_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Event handler for the &#39;message&#39; event&quot;&quot;&quot;</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Handling message from a public channel&quot;</span><span class="p">)</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="s1">&#39;groupchat&#39;</span>
        <span class="k">elif</span> <span class="n">channel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Handling message from a private group&quot;</span><span class="p">)</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="s1">&#39;groupchat&#39;</span>
        <span class="k">elif</span> <span class="n">channel</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;D&#39;</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Handling message from a user&quot;</span><span class="p">)</span>
            <span class="n">message_type</span> <span class="o">=</span> <span class="s1">&#39;chat&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Unknown message type! Unable to handle&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">subtype</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subtype&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;message_deleted&quot;</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Message of type message_deleted, ignoring this event&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">subtype</span> <span class="o">==</span> <span class="s2">&quot;message_changed&quot;</span> <span class="ow">and</span> <span class="s1">&#39;attachments&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]:</span>
            <span class="c1"># If you paste a link into Slack, it does a call-out to grab details</span>
            <span class="c1"># from it so it can display this in the chatroom. These show up as</span>
            <span class="c1"># message_changed events with an &#39;attachments&#39; key in the embedded</span>
            <span class="c1"># message. We should completely ignore these events otherwise we</span>
            <span class="c1"># could end up processing bot commands twice (user issues a command</span>
            <span class="c1"># containing a link, it gets processed, then Slack triggers the</span>
            <span class="c1"># message_changed event and we end up processing it again as a new</span>
            <span class="c1"># message. This is not what we want).</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Ignoring message_changed event with attachments, likely caused &quot;</span>
                <span class="s2">&quot;by Slack auto-expanding a link&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">event</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">][</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bot_id&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">]</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bot_id&#39;</span><span class="p">))</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;&lt;[^&gt;]*&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_angle_brackets_from_uris</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Saw an event: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">type_</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span>
            <span class="n">extras</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;attachments&#39;</span><span class="p">:</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attachments&#39;</span><span class="p">)})</span>

        <span class="k">if</span> <span class="n">message_type</span> <span class="o">==</span> <span class="s1">&#39;chat&#39;</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username_to_userid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">username</span><span class="p">),</span>
                                     <span class="n">event</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="n">SlackMUCOccupant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">SlackMUCOccupant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">username_to_userid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">username</span><span class="p">),</span>
                                      <span class="n">event</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callback_message</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<div class="viewcode-block" id="SlackBackend.userid_to_username"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.userid_to_username">[docs]</a>    <span class="k">def</span> <span class="nf">userid_to_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack user ID to their user name&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">users</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id_</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserDoesNotExistError</span><span class="p">(</span><span class="s2">&quot;Cannot find user with ID </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">id_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="SlackBackend.username_to_userid"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.username_to_userid">[docs]</a>    <span class="k">def</span> <span class="nf">username_to_userid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack user name to their user ID&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="p">[</span><span class="n">user</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">users</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UserDoesNotExistError</span><span class="p">(</span><span class="s2">&quot;Cannot find user </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="SlackBackend.channelid_to_channelname"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.channelid_to_channelname">[docs]</a>    <span class="k">def</span> <span class="nf">channelid_to_channelname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack channel ID to its channel name&quot;&quot;&quot;</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">channels</span> <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id_</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">channel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RoomDoesNotExistError</span><span class="p">(</span><span class="s2">&quot;No channel with ID </span><span class="si">%s</span><span class="s2"> exists&quot;</span> <span class="o">%</span> <span class="n">id_</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="SlackBackend.channelname_to_channelid"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.channelname_to_channelid">[docs]</a>    <span class="k">def</span> <span class="nf">channelname_to_channelid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert a Slack channel name to its channel ID&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">channel</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">channels</span> <span class="k">if</span> <span class="n">channel</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">channel</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RoomDoesNotExistError</span><span class="p">(</span><span class="s2">&quot;No channel named </span><span class="si">%s</span><span class="s2"> exists&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">channel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="SlackBackend.channels"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.channels">[docs]</a>    <span class="k">def</span> <span class="nf">channels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_archived</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">joined_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all channels and groups and return information about them.</span>

<span class="sd">        :param exclude_archived:</span>
<span class="sd">            Exclude archived channels/groups</span>
<span class="sd">        :param joined_only:</span>
<span class="sd">            Filter out channels the bot hasn&#39;t joined</span>
<span class="sd">        :returns:</span>
<span class="sd">            A list of channel (https://api.slack.com/types/channel)</span>
<span class="sd">            and group (https://api.slack.com/types/group) types.</span>

<span class="sd">        See also:</span>
<span class="sd">          * https://api.slack.com/methods/channels.list</span>
<span class="sd">          * https://api.slack.com/methods/groups.list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.list&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;exclude_archived&#39;</span><span class="p">:</span> <span class="n">exclude_archived</span><span class="p">})</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">channel</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;channels&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">channel</span><span class="p">[</span><span class="s1">&#39;is_member&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">joined_only</span><span class="p">]</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.list&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;exclude_archived&#39;</span><span class="p">:</span> <span class="n">exclude_archived</span><span class="p">})</span>
        <span class="c1"># No need to filter for &#39;is_member&#39; in this next call (it doesn&#39;t</span>
        <span class="c1"># (even exist) because leaving a group means you have to get invited</span>
        <span class="c1"># back again by somebody else.</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">group</span> <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">]]</span>

        <span class="k">return</span> <span class="n">channels</span> <span class="o">+</span> <span class="n">groups</span></div>

    <span class="nd">@lru_cache</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<div class="viewcode-block" id="SlackBackend.get_im_channel"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.get_im_channel">[docs]</a>    <span class="k">def</span> <span class="nf">get_im_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open a direct message channel to a user&quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;im.open&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">id_</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;channel&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="SlackBackend.send_message"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.send_message">[docs]</a>    <span class="k">def</span> <span class="nf">send_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mess</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">send_message</span><span class="p">(</span><span class="n">mess</span><span class="p">)</span>
        <span class="n">to_humanreadable</span> <span class="o">=</span> <span class="s2">&quot;&lt;unknown&gt;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mess</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;groupchat&#39;</span><span class="p">:</span>
                <span class="n">to_humanreadable</span> <span class="o">=</span> <span class="n">mess</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">username</span>
                <span class="n">to_channel_id</span> <span class="o">=</span> <span class="n">mess</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">channelid</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">to_humanreadable</span> <span class="o">=</span> <span class="n">mess</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">username</span>
                <span class="n">to_channel_id</span> <span class="o">=</span> <span class="n">mess</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">channelid</span>
                <span class="k">if</span> <span class="n">to_channel_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;This is a divert to private message, sending it directly to the user.&quot;</span><span class="p">)</span>
                    <span class="n">to_channel_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_im_channel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username_to_userid</span><span class="p">(</span><span class="n">to_humanreadable</span><span class="p">))</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Sending </span><span class="si">%s</span><span class="s1"> message to </span><span class="si">%s</span><span class="s1"> (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mess</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">to_humanreadable</span><span class="p">,</span> <span class="n">to_channel_id</span><span class="p">))</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">mess</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Message size: </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">))</span>

            <span class="n">limit</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bot_config</span><span class="o">.</span><span class="n">MESSAGE_SIZE_LIMIT</span><span class="p">,</span> <span class="n">SLACK_MESSAGE_LIMIT</span><span class="p">)</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_message_body</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">rtm_send_message</span><span class="p">(</span><span class="n">to_channel_id</span><span class="p">,</span> <span class="n">part</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;An exception occurred while trying to send the following message &quot;</span>
                <span class="s2">&quot;to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_humanreadable</span><span class="p">,</span> <span class="n">mess</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="SlackBackend.change_presence"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.change_presence">[docs]</a>    <span class="k">def</span> <span class="nf">change_presence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">ONLINE</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;users.setPresence&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;presence&#39;</span><span class="p">:</span> <span class="s1">&#39;auto&#39;</span> <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">ONLINE</span> <span class="k">else</span> <span class="s1">&#39;away&#39;</span><span class="p">})</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="SlackBackend.prepare_message_body"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.prepare_message_body">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_message_body</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">size_limit</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the parts of a message chunked and ready for sending.</span>

<span class="sd">        This is a staticmethod for easier testing.</span>

<span class="sd">        Args:</span>
<span class="sd">            body (str)</span>
<span class="sd">            size_limit (int): chunk the body into sizes capped at this maximum</span>

<span class="sd">        Returns:</span>
<span class="sd">            [str]</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fixed_format</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span>  <span class="c1"># hack to fix the formatting</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">split_string_after</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">size_limit</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># If we&#39;ve got an open fixed block, close it out</span>
            <span class="k">if</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">```</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">part</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
                <span class="n">starts_with_code</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span>

                <span class="c1"># If we&#39;re continuing a fixed block from the last part</span>
                <span class="k">if</span> <span class="n">fixed_format</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">starts_with_code</span><span class="p">:</span>
                    <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;```</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">part</span>

                <span class="c1"># If we&#39;ve got an open fixed block, close it out</span>
                <span class="k">if</span> <span class="n">part</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;```&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">parts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">```</span><span class="se">\n</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">parts</span></div>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="SlackBackend.extract_identifiers_from_string"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.extract_identifiers_from_string">[docs]</a>    <span class="k">def</span> <span class="nf">extract_identifiers_from_string</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse a string for Slack user/channel IDs.</span>

<span class="sd">        Supports strings with the following formats::</span>

<span class="sd">            &lt;#C12345&gt;</span>
<span class="sd">            &lt;@U12345&gt;</span>
<span class="sd">            @user</span>
<span class="sd">            #channel/user</span>
<span class="sd">            #channel</span>

<span class="sd">        Returns the tuple (username, userid, channelname, channelid).</span>
<span class="sd">        Some elements may come back as None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exception_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Unparseable slack identifier, should be of the format `&lt;#C12345&gt;`, `&lt;@U12345&gt;`, &quot;</span>
            <span class="s2">&quot;`@user`, `#channel/user` or `#channel`. (Got `</span><span class="si">%s</span><span class="s2">`)&quot;</span>
        <span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">exception_message</span> <span class="o">%</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="n">channelname</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">username</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">channelid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">userid</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&lt;&quot;</span> <span class="ow">and</span> <span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span>
            <span class="n">exception_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Unparseable slack ID, should start with U, B, C, G or D &quot;</span>
                <span class="s2">&quot;(got `</span><span class="si">%s</span><span class="s2">`)&quot;</span>
            <span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">exception_message</span> <span class="o">%</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">):</span>
                <span class="n">userid</span> <span class="o">=</span> <span class="n">text</span>
            <span class="k">elif</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;G&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">):</span>
                <span class="n">channelid</span> <span class="o">=</span> <span class="n">text</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">exception_message</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;@&#39;</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">elif</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">:</span>
            <span class="n">plainrep</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                <span class="n">channelname</span><span class="p">,</span> <span class="n">username</span> <span class="o">=</span> <span class="n">plainrep</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">channelname</span> <span class="o">=</span> <span class="n">plainrep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">exception_message</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">username</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">channelname</span><span class="p">,</span> <span class="n">channelid</span></div>

<div class="viewcode-block" id="SlackBackend.build_identifier"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.build_identifier">[docs]</a>    <span class="k">def</span> <span class="nf">build_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txtrep</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build a :class:`SlackIdentifier` from the given string txtrep.</span>

<span class="sd">        Supports strings with the formats accepted by</span>
<span class="sd">        :func:`~extract_identifiers_from_string`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;building an identifier from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">txtrep</span><span class="p">)</span>
        <span class="n">username</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">channelname</span><span class="p">,</span> <span class="n">channelid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_identifiers_from_string</span><span class="p">(</span><span class="n">txtrep</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">userid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_im_channel</span><span class="p">(</span><span class="n">userid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">channelid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">channelid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">username</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">userid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username_to_userid</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SlackIdentifier</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_im_channel</span><span class="p">(</span><span class="n">userid</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">channelname</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">channelid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channelname_to_channelid</span><span class="p">(</span><span class="n">channelname</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">SlackMUCOccupant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="n">userid</span><span class="p">,</span> <span class="n">channelid</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;You found a bug. I expected at least one of userid, channelid, username or channelname &quot;</span>
            <span class="s2">&quot;to be resolved but none of them were. This shouldn&#39;t happen so, please file a bug.&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SlackBackend.build_reply"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.build_reply">[docs]</a>    <span class="k">def</span> <span class="nf">build_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mess</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">msg_type</span> <span class="o">=</span> <span class="n">mess</span><span class="o">.</span><span class="n">type</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_message</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">frm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot_identifier</span>
        <span class="n">response</span><span class="o">.</span><span class="n">to</span> <span class="o">=</span> <span class="n">mess</span><span class="o">.</span><span class="n">frm</span>
        <span class="n">response</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="s1">&#39;chat&#39;</span> <span class="k">if</span> <span class="n">private</span> <span class="k">else</span> <span class="n">msg_type</span>

        <span class="k">return</span> <span class="n">response</span></div>

<div class="viewcode-block" id="SlackBackend.shutdown"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span></div>

    <span class="nd">@deprecated</span>
    <span class="k">def</span> <span class="nf">join_room</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">room</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_room</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;slack&#39;</span>

<div class="viewcode-block" id="SlackBackend.query_room"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.query_room">[docs]</a>    <span class="k">def</span> <span class="nf">query_room</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">room</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Room can either be a name or a channelid &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">room</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">room</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">SlackRoom</span><span class="p">(</span><span class="n">channelid</span><span class="o">=</span><span class="n">room</span><span class="p">,</span> <span class="n">bot</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">SLACK_CLIENT_CHANNEL_HYPERLINK</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">room</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SlackRoom</span><span class="p">(</span><span class="n">channelid</span><span class="o">=</span><span class="n">m</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">bot</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">SlackRoom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">room</span><span class="p">,</span> <span class="n">bot</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlackBackend.rooms"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.rooms">[docs]</a>    <span class="k">def</span> <span class="nf">rooms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of rooms the bot is currently in.</span>

<span class="sd">        :returns:</span>
<span class="sd">            A list of :class:`~SlackRoom` instances.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span><span class="n">joined_only</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">exclude_archived</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">SlackRoom</span><span class="p">(</span><span class="n">channelid</span><span class="o">=</span><span class="n">channel</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">bot</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">]</span></div>

<div class="viewcode-block" id="SlackBackend.prefix_groupchat_reply"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.prefix_groupchat_reply">[docs]</a>    <span class="k">def</span> <span class="nf">prefix_groupchat_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="n">message</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="s1">&#39;@{0}: {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">identifier</span><span class="o">.</span><span class="n">nick</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">body</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlackBackend.remove_angle_brackets_from_uris"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackBackend.remove_angle_brackets_from_uris">[docs]</a>    <span class="k">def</span> <span class="nf">remove_angle_brackets_from_uris</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">match_object</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;://&quot;</span> <span class="ow">in</span> <span class="n">match_object</span><span class="o">.</span><span class="n">group</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">match_object</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&lt;&gt;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">match_object</span><span class="o">.</span><span class="n">group</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SlackRoom"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom">[docs]</a><span class="k">class</span> <span class="nc">SlackRoom</span><span class="p">(</span><span class="n">MUCRoom</span><span class="p">):</span>
<div class="viewcode-block" id="SlackRoom.__init__"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">channelid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bot</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">channelid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;channelid and name are mutually exclusive&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">channelid_to_channelname</span><span class="p">(</span><span class="n">channelid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span> <span class="o">=</span> <span class="n">bot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sc</span> <span class="o">=</span> <span class="n">bot</span><span class="o">.</span><span class="n">sc</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;#</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The channel object exposed by SlackClient</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">id_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">channels</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">id_</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RoomDoesNotExistError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> does not exist (or is a private group you don&#39;t have access to)&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">id_</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_channel_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Channel info as returned by the Slack API.</span>

<span class="sd">        See also:</span>
<span class="sd">          * https://api.slack.com/methods/channels.list</span>
<span class="sd">          * https://api.slack.com/methods/groups.list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.info&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})[</span><span class="s2">&quot;group&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.info&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})[</span><span class="s2">&quot;channel&quot;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">private</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the room is a private group&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;G&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the ID of this room&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the name of this room&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>

<div class="viewcode-block" id="SlackRoom.join"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Joining channel </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.join&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">SlackAPIResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;user_is_bot&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="s2">&quot;Unable to join channel. &quot;</span> <span class="o">+</span> <span class="n">USER_IS_BOT_HELPTEXT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlackRoom.leave"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom.leave">[docs]</a>    <span class="k">def</span> <span class="nf">leave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Leaving channel </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.leave&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Leaving group </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.leave&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">SlackAPIResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;user_is_bot&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="s2">&quot;Unable to leave channel. &quot;</span> <span class="o">+</span> <span class="n">USER_IS_BOT_HELPTEXT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="SlackRoom.create"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">private</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating group </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.create&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating channel </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.create&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">SlackAPIResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;user_is_bot&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="s2">&quot;Unable to create channel. &quot;</span> <span class="o">+</span> <span class="n">USER_IS_BOT_HELPTEXT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></div>

<div class="viewcode-block" id="SlackRoom.destroy"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom.destroy">[docs]</a>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving channel </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.archive&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Archiving group </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.archive&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">SlackAPIResponseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">error</span> <span class="o">==</span> <span class="s2">&quot;user_is_bot&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="s2">&quot;Unable to archive channel. &quot;</span> <span class="o">+</span> <span class="n">USER_IS_BOT_HELPTEXT</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_id</span> <span class="o">=</span> <span class="bp">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span><span class="n">joined_only</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">exclude_archived</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">joined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">channels</span><span class="p">(</span><span class="n">joined_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">([</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">topic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_info</span><span class="p">[</span><span class="s1">&#39;topic&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_info</span><span class="p">[</span><span class="s1">&#39;topic&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="nd">@topic.setter</span>
    <span class="k">def</span> <span class="nf">topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting topic of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">topic</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.setTopic&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">:</span> <span class="n">topic</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting topic of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">topic</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.setTopic&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;topic&#39;</span><span class="p">:</span> <span class="n">topic</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">purpose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_info</span><span class="p">[</span><span class="s1">&#39;purpose&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_info</span><span class="p">[</span><span class="s1">&#39;purpose&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>

    <span class="nd">@purpose.setter</span>
    <span class="k">def</span> <span class="nf">purpose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">purpose</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting purpose of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">purpose</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;groups.setPurpose&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="n">purpose</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting purpose of </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">) to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">purpose</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;channels.setPurpose&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="n">purpose</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">occupants</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">members</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_channel_info</span><span class="p">[</span><span class="s1">&#39;members&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">SlackMUCOccupant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">userid_to_username</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">members</span><span class="p">]</span>

<div class="viewcode-block" id="SlackRoom.invite"><a class="viewcode-back" href="../../../errbot.backends.slack.html#errbot.backends.slack.SlackRoom.invite">[docs]</a>    <span class="k">def</span> <span class="nf">invite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">users</span> <span class="o">=</span> <span class="p">{</span><span class="n">user</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span> <span class="n">user</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s1">&#39;users.list&#39;</span><span class="p">)[</span><span class="s1">&#39;members&#39;</span><span class="p">]}</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">UserDoesNotExistError</span><span class="p">(</span><span class="s2">&quot;User &#39;</span><span class="si">%s</span><span class="s2">&#39; not found&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inviting </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;groups.invite&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">private</span> <span class="k">else</span> <span class="s1">&#39;channels.invite&#39;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bot</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span>
                <span class="n">method</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;channel&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">[</span><span class="n">user</span><span class="p">]},</span>
                <span class="n">raise_errors</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;ok&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user_is_bot&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RoomError</span><span class="p">(</span><span class="s2">&quot;Unable to invite people. &quot;</span> <span class="o">+</span> <span class="n">USER_IS_BOT_HELPTEXT</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;already_in_channel&quot;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">SlackAPIResponseError</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="s2">&quot;Slack API call to </span><span class="si">%s</span><span class="s2"> failed: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">]))</span></div></div>
</pre></div>
  <div id="prev_next_links">
      
          
          
      
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
    <a class="logo" href="../../../index.html" title="Back to home page">
        <img class="logo" src="../../../_static/err_speech.png" width="220" height="135" alt="Logo of Err"/>
    </a>
    <div class="ghbuttons">
        <iframe src="http://ghbtns.com/github-btn.html?user=errbotio&repo=errbot&type=watch&count=true"
                allowtransparency="true" frameborder="0" scrolling="0" width="95" height="20"></iframe>
        <iframe src="http://ghbtns.com/github-btn.html?user=errbotio&repo=errbot&type=fork&count=true" allowtransparency="true"
                frameborder="0" scrolling="0" width="95" height="20"></iframe>
    </div><h3>Related Topics</h3>
<ul>
    <li><a href="../../../index.html">Homepage</a></li>
    <li><a href="../../../genindex.html">Index</a></li>
    <li><a href="../../../py-modindex.html">Module index</a></li>
    <li><a href="../../../modules.html">API reference</a></li>
        <li>
        <a href="../../index.html">Module code</a>
        <ul>
        <li>
        <a href="../../errbot.html">errbot</a>
        <ul>
        </ul>
        </li>
        </ul>
        </li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <script>
        $(document).ready(function () {
            $('.fancybox').fancybox({
                padding: 0,
                openEffect: 'elastic'
            });
        });
    </script>
    <div class="relbar2">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">Err 3.2.3 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="../../errbot.html" >errbot</a> &raquo;</li> 
      </ul>
    </div>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Guillaume Binet, Tali Davidovich Petrover and Nick Groenen.
          Last updated on Feb 28, 2016.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a>.
    </div>
    
  </body>
</html>